8월 26일 목요일

링크 : https://javascript.plainenglish.io/where-to-store-the-json-web-token-jwt-4f76abcd4577



# JWT 는 어디에 저장해야 하는가?

## 서문
* 저자가 웹개발을 해온 7년간 지켜온 바에 따르면, RESTful 서비스들은 주로 JSON Web Token을 인증 토큰으로서 사용했다고 한다.
* JWT 기반의 인증을 실행할 때마다, 스스로에게 "JWT는 어디에 저장해야 하는가?" 라는 물음을 던졌다고 함.
* 브라우저 기반의 글임을 주의!
* 클라이언트에 데이터를 저장하는 방법은 크게 세가지가 있는데, 이들은 모두 각자 장단이 있다. 밑에서 알아보자.


## 쿠키
* JWT를 쿠키에 저장하면, 브라우저는 같은 URL 요청에 따라 자동적으로 토큰을 보낸다.
* 그러나 이 방법은 CSRF(Cross-Site-Request-Forgery : 사이트 간 요청 위조) 에 취약하다.
* CSRF로부터 사이트를 보호하려면 쿠키를 `SameSite=strict` 설정으로 해두면 된다.
* 또 XSS 같은 공격은 `httpOnly` flag를 둠으로써 막을수도 있다.
* 따라서 장점은 1. 브라우저가 자동으로 서버에 토큰을 보내준다. 2. 여러 탭을 열어도 같은 토큰을 사용 가능하다.
* 단점은 1. httpOnly 를 지원하지 않는 브라우저라면 XSS 공격에 취약하다.  2. OAuth2.0 같은 프로토콜을 사용한다면 헤더에 토큰을 붙여야 한다.


## 로컬 스토리지
* URL에 따라 자동적으로 데이터를 보내지 않는다.
* 따라서 auth를 위해 모든 URL에 대해 시스템을 실행해야 한다.
* 그러나 이 방법은 CSRF로부터 취약하지 않다는 점이 좋다.
* 따라서 장점은 1. CSRF에 취약하지 않다. 2. 여러 탭을 열어도 같은 토큰을 사용 가능하다.
* 단점은 1. XSS에 취약하다. 2. 토큰을 보내기 위해 메카니즘을 실행해야 한다.


## 세션 스토리지
* 로컬 스토리지랑 거의 비슷한데, 다른 점은 토큰이 하나의 탭에서만 접근할 수 있다는 점이다.
* 탭이 닫히면 세션이 종료되기 때문에, 유저 정보를 유지해야 하는 경우에는 적합하지 않을 수 있다.
* 그러나 각 탭 별로 다른 아이디로 로그인을 하는 멀티 로그인 기능을 구현하려 할 때는 괜찮은 방법일 수 있다.
* 따라서 장점은 1. CSRF에 취약하지 않다. 2. 하나의 브라우저에서 멀티 로그인 기능을 구현하기 쉽다.
* 단점은 1. XSS 공격에 취약하다. 2. 탭이 닫히면, 세션이 종료된다.


## 그래서 뭘 쓰라는거야?
* 눈치빠른 독자라면, **세 방법 모두 XSS에 취약하다** 라는 공통점을 발견했을 것이다.\
* 따라서 XSS 공격을 방지하려면 다음 글을 참고해보는 것도 좋다.
* https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html
* 로컬, 세션 스토리지는 기본적으로 XSS를 방어할 수 없지만, 쿠키는 `SameSite`나, `HttpOnly` 와 같은 보안 옵션을 제공한다.
* **그래서 결론! 보안 flag들과 함께 JWT를 쿠키에 저장하는 것이 좋지만, 맹신하지는 말자!**
